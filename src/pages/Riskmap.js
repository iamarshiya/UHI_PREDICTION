import { useState, useEffect } from "react";
import { PUNE_LOCALITIES } from "./Dashboard";

const STYLES = `
  @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
  body { background: #f3f4f6; }
  
  @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
  .animate-up { animation: fadeUp 0.5s ease both; }
`;

export default function Riskmap() {
  const [activeTab, setActiveTab] = useState("current"); // current | future
  const [loading, setLoading] = useState(true);
  const [errorMsg, setErrorMsg] = useState("");
  
  // HTML strings generated by Folium from the backend
  const [currentMapHtml, setCurrentMapHtml] = useState("");
  const [futureMapHtml, setFutureMapHtml] = useState("");

  useEffect(() => {
    fetchMaps();
  }, []);

  const fetchMaps = async () => {
    setLoading(true);
    setErrorMsg("");
    try {
      // 1. Fetch Heatmaps
      const resMaps = await fetch("http://127.0.0.1:5000/generate-maps?city=Pune");
      if (!resMaps.ok) throw new Error("Failed to fetch maps.");
      const dataMaps = await resMaps.json();
      setCurrentMapHtml(dataMaps.current_map);
      setFutureMapHtml(dataMaps.future_map);
    } catch (err) {
      console.error(err);
      setErrorMsg("Failed to fetch maps from backend. Make sure the python backend is running locally on port 5000.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ minHeight: "100vh", paddingBottom: 64 }}>
      <style>{STYLES}</style>

      {/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */}
      <div style={{ background: "#030712", padding: "40px 32px 64px" }}>
        <div style={{ maxWidth: 1400, margin: "0 auto", display: "flex", justifyContent: "space-between", alignItems: "flex-end", flexWrap: "wrap", gap: 24 }}>
          <div>
            <h1 style={{ fontSize: 36, fontWeight: 900, color: "#fff", letterSpacing: "-1px", marginBottom: 8 }}>
              Urban Heat Risk Map
            </h1>
            <p style={{ color: "#9ca3af", fontSize: 15 }}>Real-time satellite thermal imaging & predictive AI projections.</p>
          </div>

          {!loading && !errorMsg && (
            <div style={{ display: "flex", background: "#1f2937", padding: 6, borderRadius: 12 }}>
              <button 
                onClick={() => setActiveTab("current")}
                style={{
                  padding: "10px 20px", fontSize: 14, fontWeight: 700, border: "none", cursor: "pointer", borderRadius: 8, transition: "0.2s",
                  background: activeTab === "current" ? "#ef4444" : "transparent",
                  color: activeTab === "current" ? "#fff" : "#9ca3af"
                }}
              >
                üî• Live Heatmap
              </button>
              <button 
                onClick={() => setActiveTab("future")}
                style={{
                  padding: "10px 20px", fontSize: 14, fontWeight: 700, border: "none", cursor: "pointer", borderRadius: 8, transition: "0.2s",
                  background: activeTab === "future" ? "#f59e0b" : "transparent",
                  color: activeTab === "future" ? "#fff" : "#9ca3af"
                }}
              >
                ‚è≥ 3-Month Projection
              </button>
            </div>
          )}
        </div>
      </div>

      {/* ‚îÄ‚îÄ Main Dashboard Content (Split Screen) ‚îÄ‚îÄ */}
      <div style={{ maxWidth: 1400, margin: "-32px auto 0", padding: "0 32px", position: "relative", zIndex: 10 }}>
        
        {loading ? (
          <div style={{ background: "#fff", borderRadius: 20, padding: 80, textAlign: "center", boxShadow: "0 4px 24px rgba(0,0,0,0.06)" }}>
            <div style={{ width: 44, height: 44, border: "3px solid #e5e7eb", borderTopColor: "#ef4444", borderRadius: "50%", animation: "spin 1s linear infinite", margin: "0 auto 20px" }} />
            <h3 style={{ fontSize: 20, fontWeight: 800, color: "#111827" }}>Generating High-Res Satellite Maps...</h3>
            <p style={{ color: "#6b7280", fontSize: 15, marginTop: 6, maxWidth: 500, margin: "6px auto 0" }}>
              Pulling data from Google Earth Engine, rendering topological features, and plotting risk zones using Folium. This can take ~25 seconds.
            </p>
            <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
          </div>
        ) : errorMsg ? (
          <div style={{ background: "#fef2f2", borderRadius: 20, padding: 40, textAlign: "center", border: "1.5px solid #fecaca" }}>
            <div style={{ fontSize: 32, marginBottom: 12 }}>‚ö†Ô∏è</div>
            <h3 style={{ fontSize: 18, fontWeight: 700, color: "#991b1b" }}>Wait! Backend Connection Failed</h3>
            <p style={{ color: "#b91c1c", fontSize: 14, marginTop: 4, maxWidth: 600, margin: "4px auto 0" }}>{errorMsg}</p>
          </div>
        ) : (
            <div className="animate-up" style={{ background: "#fff", borderRadius: 24, padding: 16, boxShadow: "0 10px 40px rgba(0,0,0,0.08)", border: "1px solid #f3f4f6" }}>
              <div style={{ padding: "8px 12px 16px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  <span style={{ display: "flex", width: 12, height: 12, borderRadius: "50%", background: activeTab === "current" ? "#ef4444" : "#f59e0b", boxShadow: activeTab === "current" ? "0 0 10px #ef4444" : "0 0 10px #f59e0b" }}></span>
                  <h3 style={{ fontSize: 18, fontWeight: 800, color: "#111827" }}>
                    {activeTab === "current" ? "Current Heat Risk Density Map" : "Projected Risk Density (3 Months)"}
                  </h3>
                </div>
                <p style={{ fontSize: 13, color: "#6b7280", fontWeight: 600 }}>Pune City</p>
              </div>

              <div style={{ width: "100%", height: "70vh", minHeight: 600, borderRadius: 16, overflow: "hidden", background: "#e5e7eb" }}>
                <iframe 
                  title="Folium Heatmap"
                  srcDoc={activeTab === "current" ? currentMapHtml : futureMapHtml}
                  style={{ width: "100%", height: "100%", border: "none" }}
                />
              </div>

            </div>
        )}
      </div>
    </div>
  );
}